é€™æ˜¯ä¸€ä»½é‡å°æ‚¨éœ€æ±‚çš„å®Œæ•´ç¸½çµï¼Œä»¥åŠä¸€ä»½å¯ç›´æ¥æä¾›çµ¦é–‹ç™¼åœ˜éšŠçš„ **Markdown æ¸¬è©¦æŒ‡å¼•æ–‡ä»¶**ã€‚

### ç¸½çµï¼šå¦‚ä½•é”æˆæ¸¬è©¦ç›®æ¨™

è¦å®Œæˆæ‚¨æåˆ°çš„å››å€‹ç›®æ¨™ï¼ˆæ¨™æº–åŒ–å›æ‡‰ã€é‚Šéš›æƒ…æ³ã€CORS/Rate Limitã€PRD é©—è­‰ï¼‰ï¼Œæˆ‘å€‘æ¡å–äº† **ã€Œåˆ†å±¤æ¸¬è©¦ç­–ç•¥ã€**ã€‚è«‹ä¾åºåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š

1.  **è£œé½ŠåŸºç¤è¨­æ–½ (Infrastructure Implementation)**ï¼š

    - ç”±æ–¼ Elysia é è¨­æ²’æœ‰ CORS å’Œ Rate Limitï¼Œæ‚¨å¿…é ˆå…ˆå®‰è£ä¸¦æ›è¼‰æ’ä»¶ï¼Œå¦å‰‡åŸºç¤è¨­æ–½æ¸¬è©¦æœƒå¤±æ•—ã€‚
    - `bun add @elysiajs/cors elysia-rate-limit`
    - åœ¨ `index.ts` ä¸­ `.use()` é€™äº›æ’ä»¶ã€‚

2.  **æº–å‚™æ¸¬è©¦ç’°å¢ƒ (Environment Setup)**ï¼š

    - å»ºç«‹ `.env.test`ï¼ŒæŒ‡å‘ä¸€å€‹å°ˆé–€çš„æ¸¬è©¦è³‡æ–™åº« (Test DB)ã€‚
    - ç¢ºä¿ `seed.ts` è…³æœ¬èƒ½æ¥å— `force` åƒæ•¸ä¾†é‡ç½®è³‡æ–™åº«ã€‚

3.  **æ’°å¯«å…©å±¤æ¸¬è©¦ (Two-Layer Testing)**ï¼š

    - **Integration Tests (`products-integration.test.ts`)**ï¼šä½¿ç”¨ `app.handle`ã€‚å°ˆæ³¨æ–¼é©—è­‰ã€Œé‚è¼¯æ­£ç¢ºæ€§ã€èˆ‡ã€Œè³‡æ–™çµæ§‹æ˜¯å¦ç¬¦åˆ PRDã€ã€‚é€™å±¤æ¸¬è©¦è² è²¬ **ç›®æ¨™ 1, 2, 4**ã€‚
    - **Infrastructure Tests (`infrastructure.test.ts`)**ï¼šå•Ÿå‹•çœŸå¯¦ Server (`app.listen`)ã€‚å°ˆæ³¨æ–¼é©—è­‰ HTTP Headersã€CORS é˜»æ“‹èˆ‡ Rate Limit é™åˆ¶ã€‚é€™å±¤æ¸¬è©¦è² è²¬ **ç›®æ¨™ 3**ã€‚

---

### ğŸ“‚ çµ¦é–‹ç™¼è€…çš„æ¸¬è©¦æŒ‡å¼• (TESTING_GUIDE.md)

æ‚¨å¯ä»¥å°‡ä»¥ä¸‹å…§å®¹è¤‡è£½ä¸¦å„²å­˜ç‚ºå°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹çš„ `TESTING_GUIDE.md` æˆ– `docs/TESTING.md`ã€‚

---

````markdown
# Backend API Testing Guidelines

é€™ä»½æ–‡ä»¶èªªæ˜å¦‚ä½•åŸ·è¡Œå¾Œç«¯ API æ¸¬è©¦ï¼Œç¢ºä¿æ‰€æœ‰ API ç¬¦åˆ PRD è¦ç¯„ï¼Œä¸¦æ­£ç¢ºè™•ç†å®‰å…¨æ€§é™åˆ¶ (CORS, Rate Limiting)ã€‚

## ğŸ¯ æ¸¬è©¦ç›®æ¨™

æˆ‘å€‘çš„æ¸¬è©¦ç­–ç•¥åˆ†ç‚ºå…©å±¤ï¼Œä»¥é”æˆä»¥ä¸‹ç›®æ¨™ï¼š

1. **æ¨™æº–åŒ–å›æ‡‰ (Standardized Responses)**: ç¢ºä¿æ‰€æœ‰ Endpoints å›å‚³æ ¼å¼ä¸€è‡´ (Data + Meta)ã€‚
2. **PRD é©—è­‰ (PRD Matching)**: åš´æ ¼é©—è­‰æ¬„ä½å‹åˆ¥èˆ‡çµæ§‹ã€‚
3. **é‚Šéš›æƒ…æ³ (Edge Cases)**: ç¢ºä¿ 404ã€ç„¡æ•ˆåƒæ•¸è¢«æ­£ç¢ºè™•ç†ã€‚
4. **åŸºç¤è¨­æ–½ (Infrastructure)**: é©—è­‰ CORS èˆ‡ Rate Limit ç”Ÿæ•ˆã€‚

## ğŸ›  ç’°å¢ƒè¨­å®š (Prerequisites)

### 1. æº–å‚™æ¸¬è©¦è³‡æ–™åº«

æ¸¬è©¦æœƒ**æ¸…é™¤ä¸¦é‡å»º**è³‡æ–™åº«å…§å®¹ï¼Œè«‹**çµ•å°ä¸è¦**ä½¿ç”¨æ­£å¼ç’°å¢ƒæˆ–é–‹ç™¼ç’°å¢ƒçš„è³‡æ–™åº«ã€‚

å»ºç«‹ `.env.test` æª”æ¡ˆï¼š

```env
# .env.test
DATABASE_URL=postgresql://user:password@localhost:5432/test_db_project_x
NODE_ENV=test
```
````

### 2\. è³‡æ–™åº«é·ç§»èˆ‡ç¨®å­è³‡æ–™

æ¸¬è©¦è…³æœ¬æœƒè‡ªå‹•å‘¼å« Seedï¼Œä½†é¦–æ¬¡ä½¿ç”¨è«‹ç¢ºä¿è³‡æ–™åº« Schema å·²åŒæ­¥ï¼š

```bash
# ç¢ºä¿æ¸¬è©¦è³‡æ–™åº«å­˜åœ¨ä¸¦åŒæ­¥ Schema
bunx drizzle-kit push --config=drizzle.config.ts
```

## ğŸš€ åŸ·è¡Œæ¸¬è©¦

ä½¿ç”¨ Bun å…§å»ºçš„æ¸¬è©¦åŸ·è¡Œå™¨ã€‚

### åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦

```bash
bun test
```

### åƒ…åŸ·è¡Œé‚è¼¯æ•´åˆæ¸¬è©¦ (Integration Tests)

æ­¤æ¸¬è©¦ä¸å•Ÿå‹• HTTP Serverï¼Œé€Ÿåº¦æœ€å¿«ï¼Œç”¨æ–¼é–‹ç™¼æ™‚å¿«é€Ÿé©—è­‰é‚è¼¯ã€‚

```bash
bun test tests/products-integration.test.ts
```

### åƒ…åŸ·è¡ŒåŸºç¤è¨­æ–½æ¸¬è©¦ (Infrastructure Tests)

æ­¤æ¸¬è©¦æœƒå•Ÿå‹•çœŸå¯¦ Serverï¼Œé©—è­‰ CORS headers èˆ‡ Rate Limitã€‚

```bash
bun test tests/infrastructure.test.ts
```

## ğŸ§ª æ¸¬è©¦çµæ§‹èªªæ˜

### 1\. Integration Tests (`tests/products-integration.test.ts`)

- **ç”¨é€”**: é©—è­‰å•†æ¥­é‚è¼¯ã€è³‡æ–™åº«æŸ¥è©¢çµæœã€JSON çµæ§‹ã€‚
- **æ–¹æ³•**: ä½¿ç”¨ Elysia çš„ `app.handle(new Request(...))` æ¨¡æ“¬è«‹æ±‚ã€‚
- **é—œéµé©—è­‰é»**:
  - æª¢æŸ¥ `products` é™£åˆ—èˆ‡ `meta` åˆ†é ç‰©ä»¶æ˜¯å¦å­˜åœ¨ã€‚
  - æª¢æŸ¥å–®ä¸€å•†å“ `slug` æ˜¯å¦å°æ‡‰ã€‚
  - æª¢æŸ¥éŒ¯èª¤ä»£ç¢¼ (å¦‚ 404)ã€‚

### 2\. Infrastructure Tests (`tests/infrastructure.test.ts`)

- **ç”¨é€”**: é©—è­‰ç¶²è·¯å±¤ç´šçš„å®‰å…¨è¨­å®šã€‚
- **æ–¹æ³•**: ä½¿ç”¨ `app.listen()` å•Ÿå‹•ä¼ºæœå™¨ï¼Œä¸¦ä½¿ç”¨ `fetch()` ç™¼é€çœŸå¯¦è«‹æ±‚ã€‚
- **é—œéµé©—è­‰é»**:
  - **CORS**: æª¢æŸ¥ `Access-Control-Allow-Origin` Headerã€‚
  - **Rate Limit**: é€£çºŒç™¼é€è«‹æ±‚ï¼Œç¢ºèªæ˜¯å¦å›å‚³ `429 Too Many Requests`ã€‚

## ğŸ“ é–‹ç™¼æ–°åŠŸèƒ½æ™‚çš„æ¸¬è©¦è¦ç¯„

ç•¶ä½ æ–°å¢ API åŠŸèƒ½æ™‚ï¼Œè«‹éµå¾ªä»¥ä¸‹æª¢æŸ¥æ¸…å–®ï¼š

1.  **Update Types**: ä¿®æ”¹ `model.ts` ä¸¦ç¢ºä¿ TypeBox å®šç¾©èˆ‡ PRD ä¸€è‡´ã€‚
2.  **Update Seed**: å¦‚æœæœ‰æ–°è³‡æ–™è¡¨ï¼Œè«‹æ›´æ–° `seed.ts` ä»¥ç¢ºä¿æ¸¬è©¦è³‡æ–™åº«æœ‰è³‡æ–™ã€‚
3.  **Write Test**: åœ¨ Integration Test ä¸­æ–°å¢ä¸€å€‹ `it` block é©—è­‰å›å‚³æ ¼å¼ã€‚
4.  **Verify**: åŸ·è¡Œ `bun test` ç¢ºä¿ç¶ ç‡ˆ (Green)ã€‚

## âš ï¸ å¸¸è¦‹å•é¡Œæ’é™¤

- **Error: Database connection failed**
  - æª¢æŸ¥ `.env.test` æ˜¯å¦å­˜åœ¨ã€‚
  - æª¢æŸ¥ Docker æˆ– Postgres æœå‹™æ˜¯å¦åŸ·è¡Œä¸­ã€‚
- **Tests fail with "Table not found"**
  - åŸ·è¡Œ `bunx drizzle-kit push` å°æ¸¬è©¦è³‡æ–™åº«é€²è¡Œé·ç§»ã€‚
- **Rate Limit æ¸¬è©¦å¤±æ•—**
  - ç¢ºèªæ¸¬è©¦ä¸­çš„è«‹æ±‚é–“éš”æ˜¯å¦éé•·ï¼ˆRate Limit é€šå¸¸æ˜¯è¨ˆç®—æ¯ç§’è«‹æ±‚æ•¸ï¼‰ã€‚
  - ç¢ºèª `elysia-rate-limit` æ’ä»¶å·²æ­£ç¢ºæ›è¼‰ã€‚

<!-- end list -->

```

***

### ä¸‹ä¸€æ­¥å»ºè­°

ç‚ºäº†è®“é€™ä»½æŒ‡å¼•çœŸæ­£ç™¼æ®ä½œç”¨ï¼Œæ‚¨ç¾åœ¨å¯ä»¥åšçš„æ˜¯ï¼š

1.  **å®‰è£ç¼ºå°‘çš„æ’ä»¶** (CORS/Rate Limit)ã€‚
2.  **å»ºç«‹ä¸Šè¿°çš„ Markdown æª”æ¡ˆ**ã€‚
3.  **åŸ·è¡Œä¸€æ¬¡ `bun test`**ï¼Œçœ‹è‘—æ‰€æœ‰ç¶ ç‡ˆäº®èµ·ï¼ˆé€™å°é–‹ç™¼è€…ä¾†èªªæ˜¯æœ€ç™‚ç™’çš„æ™‚åˆ»ï¼‰ã€‚

å¦‚æœæ‚¨åœ¨å¯¦ä½œ CORS æˆ– Rate Limit çš„é…ç½®ä¸Šæœ‰å›°é›£ï¼Œæˆ‘å¯ä»¥æä¾›å°æ‡‰çš„ `index.ts` ä¿®æ”¹ç¨‹å¼ç¢¼ã€‚
```
